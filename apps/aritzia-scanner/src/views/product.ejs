<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title><%= product.name %> - Aritzia Scanner</title>
    <link rel="stylesheet" href="/styles.css" />
  </head>
  <body>
    <%- include('partials/nav') %>
    <h1><%= product.name %></h1>
    <p>
      <a
        href="https://www.aritzia.com/en/product/<%= product.slug %>"
        target="_blank"
        >View on Aritzia</a
      >
    </p>
    <p class="meta">
      Added: <%= product.added_at_formatted %> | Last Seen: <%=
      product.last_seen_at_formatted %>
    </p>

    <% if (product.allLengths && product.allLengths.length > 1) { %>
    <div class="filter-box">
      <label for="length-select" class="filter-label">Filter by Length:</label>
      <select id="length-select" class="filter-select">
        <option value="all">All Lengths</option>
        <% product.allLengths.forEach(length => { %>
        <option value="<%= length %>"><%= length %></option>
        <% }); %>
      </select>
    </div>
    <% } %>

    <h2>Variants</h2>

    <% const activeVariants = product.variants.filter(v => v.isActive); const
    discontinuedVariants = product.variants.filter(v => !v.isActive); %> <% if
    (activeVariants.length > 0) { %>
    <h3>Active Variants</h3>
    <div class="variant-wrapper">
      <% activeVariants.forEach(variant => { %>
      <div
        class="variant"
        data-lengths="<%= JSON.stringify(variant.lengths) %>"
      >
        <% if (variant.thumbnail) { %>
        <a href="/product/<%= product.id %>/variant/<%= variant.color_id %>">
          <img
            src="/api/images/<%= variant.thumbnail %>"
            alt="<%= variant.color %>"
            class="variant-image"
          />
        </a>
        <% } %>
        <h3 class="variant-title">
          <a
            href="/product/<%= product.id %>/variant/<%= variant.color_id %>"
            class="variant-link"
            ><%= variant.color %></a
          >
        </h3>

        <% if (variant.price) { %>
        <div class="variant-price-container">
          <% if (variant.price < variant.list_price) { %>
          <span class="price-sale">$<%= variant.price %></span>
          <span class="price-list">$<%= variant.list_price %></span>
          <% } else { %>
          <span>$<%= variant.price %></span>
          <% } %> <% if (variant.lowest_price && variant.lowest_price <
          variant.price) { %>
          <div class="price-lowest">Lowest: $<%= variant.lowest_price %></div>
          <% } %>
        </div>
        <% } %> <% if (product.allLengths && product.allLengths.length > 1) { %>
        <p class="variant-lengths"><%= variant.lengths.join(', ') %></p>
        <% } %>
      </div>
      <% }); %>
    </div>
    <% } %> <% if (discontinuedVariants.length > 0) { %>
    <h3>Discontinued Variants</h3>
    <div class="variant-wrapper">
      <% discontinuedVariants.forEach(variant => { %>
      <div
        class="variant discontinued"
        data-lengths="<%= JSON.stringify(variant.lengths) %>"
      >
        <% if (variant.thumbnail) { %>
        <a href="/product/<%= product.id %>/variant/<%= variant.color_id %>">
          <img
            src="/api/images/<%= variant.thumbnail %>"
            alt="<%= variant.color %>"
            class="variant-image"
          />
        </a>
        <% } %>
        <h3 class="variant-title">
          <a
            href="/product/<%= product.id %>/variant/<%= variant.color_id %>"
            class="variant-link"
            ><%= variant.color %></a
          >
        </h3>

        <% if (variant.price) { %>
        <div class="variant-price-container">
          <% if (variant.price < variant.list_price) { %>
          <span class="price-sale">$<%= variant.price %></span>
          <span class="price-list">$<%= variant.list_price %></span>
          <% } else { %>
          <span>$<%= variant.price %></span>
          <% } %> <% if (variant.lowest_price && variant.lowest_price <
          variant.price) { %>
          <div class="price-lowest">Lowest: $<%= variant.lowest_price %></div>
          <% } %>
        </div>
        <% } %> <% if (product.allLengths && product.allLengths.length > 1) { %>
        <p class="variant-lengths"><%= variant.lengths.join(', ') %></p>
        <% } %>
        <p class="discontinued-label">Discontinued</p>
      </div>
      <% }); %>
    </div>
    <% } %>
    <script>
      const lengthSelect = document.getElementById('length-select');
      if (lengthSelect) {
        const variants = document.querySelectorAll('.variant');

        lengthSelect.addEventListener('change', (e) => {
          const selectedLength = e.target.value;

          variants.forEach((variant) => {
            const lengths = JSON.parse(variant.dataset.lengths || '[]');

            if (selectedLength === 'all' || lengths.includes(selectedLength)) {
              variant.style.display = 'block';
            } else {
              variant.style.display = 'none';
            }
          });
        });
      }
    </script>
  </body>
</html>
