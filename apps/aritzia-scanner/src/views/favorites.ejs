<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Favorites - Aritzia Scanner</title>
    <link rel="stylesheet" href="/styles.css" />
  </head>
  <body>
    <%- include('partials/nav') %>

    <h1>&#x2764; My Favorites</h1>

    <div id="favorites-empty" class="favorites-empty" style="display: none">
      <p>You haven't saved any favorites yet.</p>
      <p>
        Click the <span class="heart-icon-demo">&#x2661;</span> on any product
        to save it here!
      </p>
      <a href="/" class="view-all-button">Browse Products</a>
    </div>

    <div id="favorites-loading" class="skeleton-container">
      <div
        class="skeleton-shimmer"
        style="height: 200px; border-radius: 8px"
      ></div>
      <p style="text-align: center; color: #999">Loading your favorites...</p>
    </div>

    <div id="favorites-grid" class="product-grid" style="display: none"></div>

    <script>
      const FAVORITES_KEY = 'aritzia_favorites';

      function getFavorites() {
        try {
          return JSON.parse(localStorage.getItem(FAVORITES_KEY) || '[]');
        } catch {
          return [];
        }
      }

      function removeFavorite(variantId) {
        const favs = getFavorites().filter((id) => id !== String(variantId));
        localStorage.setItem(FAVORITES_KEY, JSON.stringify(favs));
        loadFavorites();
      }

      async function loadFavorites() {
        const favs = getFavorites();
        const loading = document.getElementById('favorites-loading');
        const empty = document.getElementById('favorites-empty');
        const grid = document.getElementById('favorites-grid');

        if (favs.length === 0) {
          loading.style.display = 'none';
          grid.style.display = 'none';
          empty.style.display = 'block';
          return;
        }

        loading.style.display = 'block';
        empty.style.display = 'none';
        grid.style.display = 'none';

        try {
          const resp = await fetch('/api/variants?ids=' + favs.join(','));
          const variants = await resp.json();

          if (variants.length === 0) {
            loading.style.display = 'none';
            empty.style.display = 'block';
            return;
          }

          grid.innerHTML = variants
            .map((v) => {
              const link =
                '/product/' + v.product_id + '/variant/' + v.color_id;
              const name = v.display_name || v.name;
              const hasDiscount =
                v.price && v.list_price && v.price < v.list_price;
              const discountPct = hasDiscount
                ? Math.round((1 - v.price / v.list_price) * 100)
                : 0;
              return (
                '<div class="product-card">' +
                (hasDiscount
                  ? '<span class="discount-overlay">' +
                    discountPct +
                    '% OFF</span>'
                  : '') +
                '<button class="favorite-btn favorited" onclick="removeFavorite(\'' +
                v.id +
                '\')" title="Remove from favorites">&#x2665;</button>' +
                '<a href="' +
                link +
                '" class="product-image">' +
                (v.thumbnail_id
                  ? '<img src="/api/images/' +
                    v.thumbnail_id +
                    '" alt="' +
                    name +
                    '" loading="lazy" />'
                  : '<span class="no-image-placeholder">No Image</span>') +
                '</a>' +
                '<div class="product-info">' +
                '<a href="' +
                link +
                '" class="product-name">' +
                name +
                '</a>' +
                '<div class="product-price-container">' +
                (hasDiscount
                  ? '<span class="price-sale">$' +
                    v.price +
                    '</span><span class="price-list">$' +
                    v.list_price +
                    '</span>'
                  : v.price
                  ? '<span>$' + v.price + '</span>'
                  : '') +
                '</div>' +
                '<div class="variant-details">' +
                (v.color || '') +
                (v.length ? ' (' + v.length + ')' : '') +
                '</div>' +
                '</div></div>'
              );
            })
            .join('');

          loading.style.display = 'none';
          grid.style.display = 'grid';
        } catch (err) {
          loading.innerHTML =
            '<p style="color: red;">Failed to load favorites.</p>';
        }
      }

      loadFavorites();
    </script>
  </body>
</html>
