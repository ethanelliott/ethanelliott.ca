<div class="monthly-habits-container">
  @if (loading()) {
  <div class="loading-container">
    <mat-spinner></mat-spinner>
    <p>Loading your financial data...</p>
  </div>
  } @else {

  <!-- Header with Month/Year Selection -->
  <div class="header-section">
    <div class="header-content">
      <div class="title-section">
        <h1>Monthly Habits</h1>
        <p>Analyze your spending patterns and habits for a specific month</p>
      </div>

      <div class="controls-section">
        <mat-form-field appearance="outline">
          <mat-label>Month</mat-label>
          <mat-select
            [value]="selectedMonth()"
            (selectionChange)="onMonthChange($event.value)"
          >
            @for (month of availableMonths; track month.value) {
            <mat-option [value]="month.value">{{ month.label }}</mat-option>
            }
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Year</mat-label>
          <mat-select
            [value]="selectedYear()"
            (selectionChange)="onYearChange($event.value)"
          >
            @for (year of availableYears(); track year) {
            <mat-option [value]="year">{{ year }}</mat-option>
            }
          </mat-select>
        </mat-form-field>

        <button
          mat-raised-button
          color="primary"
          (click)="navigateToOverview()"
        >
          <mat-icon fontIcon="fa-chart-line"></mat-icon>
          All-Time Overview
        </button>
      </div>
    </div>
  </div>

  <!-- Quick Stats for Selected Month -->
  <div class="month-stats-section">
    <h2>{{ getSelectedMonthName() }} {{ selectedYear() }} Summary</h2>

    <div class="quick-stats-grid">
      <mat-card class="stat-card income">
        <mat-card-content>
          <div class="stat-content">
            <div class="stat-icon">
              <mat-icon fontIcon="fa-arrow-trend-up"></mat-icon>
            </div>
            <div class="stat-info">
              <div class="stat-label">Income</div>
              <div class="stat-value">
                {{ formatCurrency(monthlyStats().totalIncome) }}
              </div>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <mat-card class="stat-card expense">
        <mat-card-content>
          <div class="stat-content">
            <div class="stat-icon">
              <mat-icon fontIcon="fa-arrow-trend-down"></mat-icon>
            </div>
            <div class="stat-info">
              <div class="stat-label">Expenses</div>
              <div class="stat-value">
                {{ formatCurrency(monthlyStats().totalExpenses) }}
              </div>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <mat-card
        class="stat-card net"
        [class.positive]="monthlyStats().netAmount >= 0"
        [class.negative]="monthlyStats().netAmount < 0"
      >
        <mat-card-content>
          <div class="stat-content">
            <div class="stat-icon">
              <mat-icon
                [fontIcon]="
                  monthlyStats().netAmount >= 0 ? 'fa-plus' : 'fa-minus'
                "
              ></mat-icon>
            </div>
            <div class="stat-info">
              <div class="stat-label">Net</div>
              <div class="stat-value">
                {{ formatCurrency(monthlyStats().netAmount) }}
              </div>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <mat-card class="stat-card transactions">
        <mat-card-content>
          <div class="stat-content">
            <div class="stat-icon">
              <mat-icon fontIcon="fa-receipt"></mat-icon>
            </div>
            <div class="stat-info">
              <div class="stat-label">Transactions</div>
              <div class="stat-value">
                {{ monthlyStats().transactionCount }}
              </div>
            </div>
          </div>
        </mat-card-content>
      </mat-card>
    </div>
  </div>

  <!-- Habits Analysis -->
  <div class="habits-section">
    <h2>Spending Habits</h2>

    <div class="habits-grid">
      <!-- Category Breakdown Chart -->
      <mat-card class="chart-card">
        <mat-card-header>
          <mat-card-title>Category Breakdown</mat-card-title>
          <mat-card-subtitle>Where your money went</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          @if (categoryBreakdown().length > 0) {
          <div class="chart-container">
            <canvas
              baseChart
              [data]="categoryChartData()"
              [options]="pieChartOptions"
              [type]="'doughnut'"
            >
            </canvas>
          </div>
          } @else {
          <div class="empty-chart">
            <mat-icon fontIcon="fa-chart-pie"></mat-icon>
            <p>No spending data for this month</p>
          </div>
          }
        </mat-card-content>
      </mat-card>

      <!-- Weekly Spending Pattern -->
      <mat-card class="chart-card">
        <mat-card-header>
          <mat-card-title>Weekly Pattern</mat-card-title>
          <mat-card-subtitle>Spending throughout the month</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          @if (filteredTransactions().length > 0) {
          <div class="chart-container">
            <canvas
              baseChart
              [data]="weeklySpendingPattern()"
              [options]="chartOptions"
              [type]="'bar'"
            >
            </canvas>
          </div>
          } @else {
          <div class="empty-chart">
            <mat-icon fontIcon="fa-chart-bar"></mat-icon>
            <p>No transactions for this month</p>
          </div>
          }
        </mat-card-content>
      </mat-card>

      <!-- Habit Insights -->
      <mat-card class="insights-card">
        <mat-card-header>
          <mat-card-title>Habit Insights</mat-card-title>
          <mat-card-subtitle>Your patterns this month</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          <div class="insights-list">
            <div class="insight-item">
              <div class="insight-icon">
                <mat-icon fontIcon="fa-layer-group"></mat-icon>
              </div>
              <div class="insight-content">
                <div class="insight-label">Top Category</div>
                <div class="insight-value">
                  {{ monthlyStats().topCategory || 'No data' }}
                </div>
              </div>
            </div>

            <div class="insight-item">
              <div class="insight-icon">
                <mat-icon fontIcon="fa-credit-card"></mat-icon>
              </div>
              <div class="insight-content">
                <div class="insight-label">Preferred Payment</div>
                <div class="insight-value">
                  {{ monthlyStats().topMedium || 'No data' }}
                </div>
              </div>
            </div>

            <div class="insight-item">
              <div class="insight-icon">
                <mat-icon fontIcon="fa-calendar"></mat-icon>
              </div>
              <div class="insight-content">
                <div class="insight-label">Most Active Day</div>
                <div class="insight-value">
                  {{ monthlyStats().mostActiveDay || 'No data' }}
                </div>
              </div>
            </div>

            <div class="insight-item">
              <div class="insight-icon">
                <mat-icon fontIcon="fa-calculator"></mat-icon>
              </div>
              <div class="insight-content">
                <div class="insight-label">Avg Transaction</div>
                <div class="insight-value">
                  {{ formatCurrency(monthlyStats().avgTransactionAmount) }}
                </div>
              </div>
            </div>

            <div class="insight-item">
              <div class="insight-icon">
                <mat-icon fontIcon="fa-chart-line"></mat-icon>
              </div>
              <div class="insight-content">
                <div class="insight-label">Daily Average</div>
                <div class="insight-value">{{ getSpendingTrend() }}</div>
              </div>
            </div>
          </div>
        </mat-card-content>
      </mat-card>
    </div>
  </div>

  <!-- Detailed Breakdowns -->
  <div class="details-section">
    <h2>Detailed Analysis</h2>

    <div class="details-grid">
      <!-- Top Categories -->
      <mat-card class="breakdown-card">
        <mat-card-header>
          <mat-card-title>Category Spending</mat-card-title>
          <mat-card-subtitle>Top categories this month</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          @if (categoryBreakdown().length > 0) {
          <div class="breakdown-list">
            @for (category of categoryBreakdown(); track category.category) {
            <div class="breakdown-item">
              <div class="breakdown-info">
                <div class="breakdown-name">{{ category.category }}</div>
                <div class="breakdown-percentage">
                  {{
                    (
                      (category.amount / monthlyStats().totalExpenses) *
                      100
                    ).toFixed(1)
                  }}%
                </div>
              </div>
              <div class="breakdown-amount">
                {{ formatCurrency(category.amount) }}
              </div>
              <div class="breakdown-bar">
                <mat-progress-bar
                  mode="determinate"
                  [value]="
                    (category.amount / monthlyStats().totalExpenses) * 100
                  "
                >
                </mat-progress-bar>
              </div>
            </div>
            }
          </div>
          } @else {
          <div class="empty-state">
            <mat-icon fontIcon="fa-layer-group"></mat-icon>
            <p>No spending categories for this month</p>
          </div>
          }
        </mat-card-content>
      </mat-card>

      <!-- Payment Methods -->
      <mat-card class="breakdown-card">
        <mat-card-header>
          <mat-card-title>Payment Methods</mat-card-title>
          <mat-card-subtitle>Usage breakdown</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          @if (mediumBreakdown().length > 0) {
          <div class="breakdown-list">
            @for (medium of mediumBreakdown(); track medium.medium) {
            <div class="breakdown-item">
              <div class="breakdown-info">
                <div class="breakdown-name">{{ medium.medium }}</div>
                <div class="breakdown-count">
                  {{ medium.count }} transactions
                </div>
              </div>
              <div class="breakdown-amounts">
                <div class="amount-detail income">
                  +{{ formatCurrency(medium.income) }}
                </div>
                <div class="amount-detail expense">
                  -{{ formatCurrency(medium.expenses) }}
                </div>
              </div>
            </div>
            }
          </div>
          } @else {
          <div class="empty-state">
            <mat-icon fontIcon="fa-credit-card"></mat-icon>
            <p>No payment methods used this month</p>
          </div>
          }
        </mat-card-content>
      </mat-card>

      <!-- Top Spending Days -->
      <mat-card class="breakdown-card">
        <mat-card-header>
          <mat-card-title>Top Spending Days</mat-card-title>
          <mat-card-subtitle>When you spent the most</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          @if (getTopSpendingDays().length > 0) {
          <div class="breakdown-list">
            @for (dayData of getTopSpendingDays(); track dayData.day) {
            <div class="breakdown-item">
              <div class="breakdown-info">
                <div class="breakdown-name">
                  {{ getSelectedMonthName() }} {{ dayData.day }}
                </div>
              </div>
              <div class="breakdown-amount">
                {{ formatCurrency(dayData.amount) }}
              </div>
            </div>
            }
          </div>
          } @else {
          <div class="empty-state">
            <mat-icon fontIcon="fa-calendar"></mat-icon>
            <p>No spending data for this month</p>
          </div>
          }
        </mat-card-content>
      </mat-card>
    </div>
  </div>

  <!-- Action Buttons -->
  <div class="actions-section">
    <button
      mat-raised-button
      color="primary"
      (click)="navigateToTransactions()"
    >
      <mat-icon fontIcon="fa-receipt"></mat-icon>
      View All Transactions
    </button>
  </div>

  }
</div>
