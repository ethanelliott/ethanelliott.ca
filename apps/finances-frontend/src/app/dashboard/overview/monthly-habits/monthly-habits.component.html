<div class="dashboard-container">
  @if (loading()) {
  <div class="loading-container">
    <mat-spinner diameter="64"></mat-spinner>
    <h3>Loading monthly insights...</h3>
    <p>
      Analyzing
      {{ monthlyStats().transactionCount.toLocaleString() }} transactions for
      {{ getSelectedMonthName() }} {{ selectedYear() }}
    </p>
  </div>
  } @else {

  <!-- Header with KPIs -->
  <section class="header">
    <div class="header-row">
      <div class="title-section">
        <h1 class="page-title">Monthly Analysis</h1>
        <p class="page-subtitle">
          {{ monthlyStats().transactionCount.toLocaleString() }} transactions •
          {{ getSelectedMonthName() }} {{ selectedYear() }} •
          {{ formatPercentage(getSavingsRate()) }} savings rate
        </p>
      </div>

      <!-- Month/Year Selection Controls -->
      <div class="controls-section">
        <mat-form-field appearance="outline">
          <mat-label>Month</mat-label>
          <mat-select
            [value]="selectedMonth()"
            (selectionChange)="onMonthChange($event.value)"
          >
            @for (month of availableMonths; track month.value) {
            <mat-option [value]="month.value">{{ month.label }}</mat-option>
            }
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Year</mat-label>
          <mat-select
            [value]="selectedYear()"
            (selectionChange)="onYearChange($event.value)"
          >
            @for (year of availableYears(); track year) {
            <mat-option [value]="year">{{ year }}</mat-option>
            }
          </mat-select>
        </mat-form-field>
      </div>
    </div>

    <!-- KPI Grid -->
    <div class="kpis">
      <div class="kpi-row">
        <div
          class="kpi-item wealth"
          [class.positive]="monthlyStats().netAmount >= 0"
          [class.negative]="monthlyStats().netAmount < 0"
        >
          <div class="kpi-icon">
            <mat-icon>
              @if (monthlyStats().netAmount >= 0) { trending_up } @else {
              trending_down }
            </mat-icon>
          </div>
          <div class="kpi-content">
            <div class="kpi-label">Net Amount</div>
            <div class="kpi-value">
              {{ formatCurrency(monthlyStats().netAmount) }}
            </div>
            <div class="kpi-detail">
              {{ formatPercentage(getSavingsRate()) }} savings rate
            </div>
          </div>
        </div>

        <div class="kpi-item income">
          <div class="kpi-icon">
            <mat-icon>paid</mat-icon>
          </div>
          <div class="kpi-content">
            <div class="kpi-label">Total Income</div>
            <div class="kpi-value">
              {{ formatCurrency(monthlyStats().totalIncome) }}
            </div>
            <div class="kpi-detail">
              @if (getBiggestIncomeTransaction()) { Largest:
              {{ formatCurrency(getBiggestIncomeTransaction()!.amount) }}
              } @else { No income data }
            </div>
          </div>
        </div>

        <div class="kpi-item expense">
          <div class="kpi-icon">
            <mat-icon>receipt</mat-icon>
          </div>
          <div class="kpi-content">
            <div class="kpi-label">Total Expenses</div>
            <div class="kpi-value">
              {{ formatCurrency(monthlyStats().totalExpenses) }}
            </div>
            <div class="kpi-detail">
              {{ formatCurrency(getDailyAverageSpending()) }}/day avg
            </div>
          </div>
        </div>

        <div class="kpi-item activity">
          <div class="kpi-icon">
            <mat-icon>bar_chart</mat-icon>
          </div>
          <div class="kpi-content">
            <div class="kpi-label">Transactions</div>
            <div class="kpi-value">
              {{ monthlyStats().transactionCount.toLocaleString() }}
            </div>
            <div class="kpi-detail">
              {{ formatCurrency(monthlyStats().avgTransactionAmount) }} avg
            </div>
          </div>
        </div>

        <div class="kpi-item transfer">
          <div class="kpi-icon">
            <mat-icon>swap_horiz</mat-icon>
          </div>
          <div class="kpi-content">
            <div class="kpi-label">Transfers</div>
            <div class="kpi-value">
              {{ monthlyStats().transferCount.toLocaleString() }}
            </div>
            <div class="kpi-detail">
              {{ formatCurrency(monthlyStats().totalTransferVolume) }} volume
            </div>
          </div>
        </div>

        <div class="kpi-item highlight">
          <div class="kpi-icon">
            <mat-icon>today</mat-icon>
          </div>
          <div class="kpi-content">
            <div class="kpi-label">Most Active Day</div>
            <div class="kpi-value">
              {{ monthlyStats().mostActiveDay || 'N/A' }}
            </div>
            <div class="kpi-detail">
              @if (getHighestSpendingDay()) { Day
              {{ getHighestSpendingDay()!.day }}:
              {{ formatCurrency(getHighestSpendingDay()!.amount) }}
              } @else { No spending data }
            </div>
          </div>
        </div>

        <div class="kpi-item info">
          <div class="kpi-icon">
            <mat-icon>label</mat-icon>
          </div>
          <div class="kpi-content">
            <div class="kpi-label">Top Category</div>
            <div class="kpi-value">
              {{ monthlyStats().topCategory || 'N/A' }}
            </div>
            <div class="kpi-detail">
              {{ getCategoryDiversity() }} categories used
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Analytics Dashboard -->
  <section class="analytics">
    <!-- Main Charts Row -->
    <div class="charts-row">
      <!-- Daily Spending Pattern -->
      <div class="chart-section trends">
        <mat-card class="chart-card">
          <mat-card-header class="header">
            <mat-card-title>
              <mat-icon>show_chart</mat-icon>
              Daily Spending Pattern
            </mat-card-title>
          </mat-card-header>
          <mat-card-content>
            @if (hasExpenseTransactions()) {
            <div class="chart-container">
              <canvas
                baseChart
                [data]="dailySpendingPattern()"
                [options]="chartOptions"
                [type]="'line'"
              >
              </canvas>
            </div>
            } @else {
            <div class="empty-chart">
              <mat-icon>show_chart</mat-icon>
              <p>No expense data for this month</p>
            </div>
            }
          </mat-card-content>
        </mat-card>
      </div>

      <!-- Category Breakdown -->
      <div class="chart-section breakdown">
        <mat-card class="chart-card">
          <mat-card-header class="header">
            <mat-card-title>
              <mat-icon>pie_chart</mat-icon>
              Spending by Category
            </mat-card-title>
          </mat-card-header>
          <mat-card-content>
            @if (hasExpenseTransactions()) {
            <div class="pie-container">
              <canvas
                baseChart
                [data]="categoryChartData()"
                [options]="pieChartOptions"
                [type]="'doughnut'"
              >
              </canvas>
            </div>
            } @else {
            <div class="empty-chart">
              <mat-icon>pie_chart</mat-icon>
              <p>No expense data</p>
            </div>
            }
          </mat-card-content>
        </mat-card>
      </div>

      <!-- Monthly Insights Panel -->
      <div class="insights-section">
        <mat-card class="insights-card">
          <mat-card-header class="header">
            <mat-card-title>
              <mat-icon lightbulb></mat-icon>
              Monthly Insights
            </mat-card-title>
          </mat-card-header>
          <mat-card-content>
            <div class="insights-grid">
              <!-- Budget Status -->
              <div class="insight-item">
                <div class="insight-icon budget" [class]="getBudgetStatus()">
                  <mat-icon>
                    @if (getBudgetStatus() === 'over') { warning } @else if
                    (getBudgetStatus() === 'on-track') { gps_fixed } @else {
                    check_circle }
                  </mat-icon>
                </div>
                <div class="insight-content">
                  <div class="insight-label">Budget Status</div>
                  <div class="insight-value">
                    {{ formatPercentage(getBudgetProgress(), 0) }}
                  </div>
                  <div class="insight-detail">of $2,000 budget used</div>
                </div>
              </div>

              <!-- Spending Velocity -->
              <div class="insight-item">
                <div
                  class="insight-icon velocity"
                  [class]="getSpendingVelocity()"
                >
                  <mat-icon>
                    @if (getSpendingVelocity() === 'high') { speed } @else if
                    (getSpendingVelocity() === 'medium') { insights } @else {
                    speed }
                  </mat-icon>
                </div>
                <div class="insight-content">
                  <div class="insight-label">Spending Pace</div>
                  <div class="insight-value">
                    {{ getSpendingVelocity() | titlecase }}
                  </div>
                  <div class="insight-detail">
                    {{ formatCurrency(getDailyAverageSpending()) }}/day
                  </div>
                </div>
              </div>

              <!-- Most Expensive Transaction -->
              @if (getMostExpensiveTransaction()) {
              <div class="insight-item">
                <div class="insight-icon expense">
                  <mat-icon receipt></mat-icon>
                </div>
                <div class="insight-content">
                  <div class="insight-label">Biggest Expense</div>
                  <div class="insight-value">
                    {{ formatCurrency(getMostExpensiveTransaction()!.amount) }}
                  </div>
                  <div class="insight-detail">
                    {{
                      getMostExpensiveTransaction()!.description
                        | slice : 0 : 20
                    }}...
                  </div>
                </div>
              </div>
              }

              <!-- Income vs Expenses -->
              <div class="insight-item">
                <div
                  class="insight-icon balance"
                  [class.positive]="monthlyStats().netAmount >= 0"
                  [class.negative]="monthlyStats().netAmount < 0"
                >
                  <mat-icon>
                    @if (monthlyStats().netAmount >= 0) { balance } @else {
                    priority_high }
                  </mat-icon>
                </div>
                <div class="insight-content">
                  <div class="insight-label">Income/Expense Ratio</div>
                  <div class="insight-value">
                    @if (monthlyStats().totalExpenses > 0) {
                    {{
                      (
                        monthlyStats().totalIncome /
                        monthlyStats().totalExpenses
                      ).toFixed(1)
                    }}:1 } @else { ∞:1 }
                  </div>
                  <div class="insight-detail">
                    {{ formatPercentage(getSavingsRate()) }} savings rate
                  </div>
                </div>
              </div>
            </div>
          </mat-card-content>
        </mat-card>
      </div>
    </div>

    <!-- Secondary Charts Row -->
    <div class="charts-row secondary">
      <!-- Weekly Spending Pattern -->
      <div class="chart-section">
        <mat-card class="chart-card">
          <mat-card-header class="header">
            <mat-card-title>
              <mat-icon date_range></mat-icon>
              Weekly Spending Pattern
            </mat-card-title>
          </mat-card-header>
          <mat-card-content>
            @if (hasExpenseTransactions()) {
            <div class="chart-container">
              <canvas
                baseChart
                [data]="weeklySpendingPattern()"
                [options]="chartOptions"
                [type]="'line'"
              >
              </canvas>
            </div>
            } @else {
            <div class="empty-chart">
              <mat-icon date_range></mat-icon>
              <p>No expense data</p>
            </div>
            }
          </mat-card-content>
        </mat-card>
      </div>

      <!-- Income vs Expenses Comparison -->
      <div class="chart-section">
        <mat-card class="chart-card">
          <mat-card-header class="header">
            <mat-card-title>
              <mat-icon bar_chart></mat-icon>
              Income vs Expenses
            </mat-card-title>
          </mat-card-header>
          <mat-card-content>
            @if (hasTransactions()) {
            <div class="pie-container">
              <canvas
                baseChart
                [data]="incomeVsExpensesChart()"
                [options]="pieChartOptions"
                [type]="'doughnut'"
              >
              </canvas>
            </div>
            } @else {
            <div class="empty-chart">
              <mat-icon bar_chart></mat-icon>
              <p>No transaction data</p>
            </div>
            }
          </mat-card-content>
        </mat-card>
      </div>
    </div>

    <!-- Analytics Grid -->
    <div class="analytics-grid">
      <!-- Transaction Highlights -->
      <mat-card class="analytics-card">
        <mat-card-header class="header">
          <mat-card-title>
            <mat-icon star></mat-icon>
            Transaction Highlights
          </mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="highlights-list">
            @if (getMostExpensiveTransaction()) {
            <div class="highlight-item expense">
              <div class="highlight-icon">
                <mat-icon keyboard_arrow_up></mat-icon>
              </div>
              <div class="highlight-content">
                <div class="highlight-label">Largest Expense</div>
                <div class="highlight-value">
                  {{ formatCurrency(getMostExpensiveTransaction()!.amount) }}
                </div>
                <div class="highlight-detail">
                  {{ getMostExpensiveTransaction()!.description }}
                </div>
                <div class="highlight-date">
                  {{ formatDateShort(getMostExpensiveTransaction()!.date) }}
                </div>
              </div>
            </div>
            } @if (getBiggestIncomeTransaction()) {
            <div class="highlight-item income">
              <div class="highlight-icon">
                <mat-icon keyboard_arrow_down></mat-icon>
              </div>
              <div class="highlight-content">
                <div class="highlight-label">Largest Income</div>
                <div class="highlight-value">
                  {{ formatCurrency(getBiggestIncomeTransaction()!.amount) }}
                </div>
                <div class="highlight-detail">
                  {{ getBiggestIncomeTransaction()!.description }}
                </div>
                <div class="highlight-date">
                  {{ formatDateShort(getBiggestIncomeTransaction()!.date) }}
                </div>
              </div>
            </div>
            }

            <div class="highlight-item info">
              <div class="highlight-icon">
                <mat-icon calculate></mat-icon>
              </div>
              <div class="highlight-content">
                <div class="highlight-label">Daily Average</div>
                <div class="highlight-value">
                  {{ formatCurrency(getDailyAverageSpending()) }}
                </div>
                <div class="highlight-detail">Average daily spending</div>
                <div class="highlight-date">
                  {{ getSpendingTrend() }}
                </div>
              </div>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Spending Insights -->
      <mat-card class="analytics-card">
        <mat-card-header class="header">
          <mat-card-title>
            <mat-icon bar_chart></mat-icon>
            Top Spending Days
          </mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="top-days-list">
            @for (day of getTopSpendingDays(); track day.day) {
            <div class="day-item">
              <div class="day-info">
                <div class="day-label">Day {{ day.day }}</div>
                <div class="day-date">{{ formatDateShort(day.date) }}</div>
              </div>
              <div class="day-amount">
                {{ formatCurrency(day.amount) }}
              </div>
            </div>
            } @if (getTopSpendingDays().length === 0) {
            <div class="empty-state">
              <mat-icon event_busy></mat-icon>
              <p>No spending data available</p>
            </div>
            }
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Category Analysis -->
      <mat-card class="analytics-card">
        <mat-card-header class="header">
          <mat-card-title>
            <mat-icon label></mat-icon>
            Category Analysis
          </mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="category-list">
            @for (category of categoryBreakdown().slice(0, 5); track
            category.category) {
            <div class="category-item">
              <div class="category-info">
                <div class="category-name">{{ category.category }}</div>
                <div class="category-percentage">
                  {{
                    formatPercentage(
                      (category.amount / monthlyStats().totalExpenses) * 100
                    )
                  }}
                </div>
              </div>
              <div class="category-amount">
                {{ formatCurrency(category.amount) }}
              </div>
            </div>
            } @if (categoryBreakdown().length === 0) {
            <div class="empty-state">
              <mat-icon label></mat-icon>
              <p>No categories available</p>
            </div>
            }
          </div>
        </mat-card-content>
      </mat-card>
    </div>

    <!-- Quick Actions -->
    <div class="actions-row">
      <mat-card class="actions-card">
        <mat-card-content>
          <div class="actions-grid">
            <button
              mat-raised-button
              color="primary"
              (click)="navigateToTransactions()"
            >
              <mat-icon list></mat-icon>
              View All Transactions
            </button>

            <button mat-raised-button (click)="navigateToCategories()">
              <mat-icon label></mat-icon>
              Manage Categories
            </button>

            <button mat-raised-button (click)="navigateToOverview()">
              <mat-icon show_chart></mat-icon>
              All-Time Overview
            </button>
          </div>
        </mat-card-content>
      </mat-card>
    </div>
  </section>

  }
</div>
