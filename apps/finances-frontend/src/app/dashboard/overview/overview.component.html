<div class="dashboard-container">
  @if (loading()) {
  <div class="loading-container">
    <mat-spinner></mat-spinner>
    <p>Loading your financial data...</p>
  </div>
  } @else {

  <!-- Compact Health Score & Quick Stats -->
  <div class="top-section">
    <!-- Compact Health Score -->
    <mat-card class="health-score-card">
      <mat-card-content>
        <div class="health-score-content">
          <div class="score-info">
            <div class="score-label">Health Score</div>
            <div class="score-value" [class]="getHealthScoreClass()">
              {{ financeStore.financialHealthScore() }}/100
            </div>
          </div>
          <div class="score-visual">
            <mat-progress-bar
              mode="determinate"
              [value]="financeStore.financialHealthScore()"
              [class]="getHealthScoreClass()"
            >
            </mat-progress-bar>
            <div class="score-description">
              {{ getHealthScoreDescription() }}
            </div>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Current Month Quick Stats -->
    <div class="quick-stats-grid">
      <mat-card class="quick-stat-card">
        <mat-card-content>
          <div class="quick-stat-content">
            <div class="quick-stat-icon income-icon">
              <mat-icon fontIcon="fa-arrow-trend-up"></mat-icon>
            </div>
            <div class="quick-stat-info">
              <div class="quick-stat-label">Month Income</div>
              <div class="quick-stat-value income">
                {{ formatCurrency(financeStore.currentMonthIncome()) }}
              </div>
              <div
                class="quick-stat-change"
                [class]="
                  getChangeClass(monthlyIncomeComparison().changePercent)
                "
              >
                {{ getChangeText(monthlyIncomeComparison()) }}
              </div>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <mat-card class="quick-stat-card">
        <mat-card-content>
          <div class="quick-stat-content">
            <div class="quick-stat-icon expense-icon">
              <mat-icon fontIcon="fa-arrow-trend-down"></mat-icon>
            </div>
            <div class="quick-stat-info">
              <div class="quick-stat-label">Month Expenses</div>
              <div class="quick-stat-value expense">
                {{ formatCurrency(financeStore.currentMonthExpenses()) }}
              </div>
              <div
                class="quick-stat-change"
                [class]="
                  getChangeClass(-monthlyExpenseComparison().changePercent)
                "
              >
                {{ getChangeText(monthlyExpenseComparison()) }}
              </div>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <mat-card class="quick-stat-card">
        <mat-card-content>
          <div class="quick-stat-content">
            <div class="quick-stat-icon net-worth-icon">
              <mat-icon
                [fontIcon]="
                  financeStore.currentMonthNet() >= 0
                    ? 'fa-building-columns'
                    : 'fa-triangle-exclamation'
                "
              ></mat-icon>
            </div>
            <div class="quick-stat-info">
              <div class="quick-stat-label">Month Net</div>
              <div
                class="quick-stat-value"
                [class]="
                  financeStore.currentMonthNet() >= 0 ? 'positive' : 'negative'
                "
              >
                {{ formatCurrency(financeStore.currentMonthNet()) }}
              </div>
              <div class="quick-stat-transactions">
                {{ financeStore.currentMonthTransactions().length }}
                transactions
              </div>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <mat-card class="quick-stat-card">
        <mat-card-content>
          <div class="quick-stat-content">
            <div class="quick-stat-icon transaction-icon">
              <mat-icon fontIcon="fa-building-columns"></mat-icon>
            </div>
            <div class="quick-stat-info">
              <div class="quick-stat-label">Net Worth</div>
              <div
                class="quick-stat-value"
                [class]="stats().netWorth >= 0 ? 'positive' : 'negative'"
              >
                {{ formatCurrency(stats().netWorth) }}
              </div>
              <div class="quick-stat-transactions">
                {{ stats().transactionCount }} total transactions
              </div>
            </div>
          </div>
        </mat-card-content>
      </mat-card>
    </div>
  </div>

  <!-- Main Content Grid -->
  <div class="main-content-grid">
    <!-- Trends Chart - Takes prominent position -->
    <section class="trends-section">
      <mat-card class="chart-card trends-chart">
        <mat-card-header>
          <mat-card-title>Financial Trends (Last 12 Months)</mat-card-title>
          <mat-card-subtitle
            >Track your income, expenses, and net over time</mat-card-subtitle
          >
        </mat-card-header>
        <mat-card-content>
          <div class="chart-container">
            <canvas
              baseChart
              [data]="monthlyTrendsChartData()"
              [options]="chartOptions"
              [type]="'line'"
            >
            </canvas>
          </div>
        </mat-card-content>
      </mat-card>
    </section>

    <!-- Category Insights -->
    <section class="category-section">
      <mat-card class="chart-card category-chart">
        <mat-card-header>
          <mat-card-title>Current Month Spending</mat-card-title>
          <mat-card-subtitle>Category breakdown</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          @if (financeStore.currentMonthCategoryBreakdown().length > 0) {
          <div class="chart-container-small">
            <canvas
              baseChart
              [data]="categoryChartData()"
              [options]="pieChartOptions"
              [type]="'doughnut'"
            >
            </canvas>
          </div>
          } @else {
          <div class="empty-chart-small">
            <mat-icon fontIcon="fa-chart-pie"></mat-icon>
            <p>No spending data</p>
          </div>
          }
        </mat-card-content>
      </mat-card>
    </section>

    <!-- Insights Panel -->
    <section class="insights-section">
      <mat-card class="insights-card">
        <mat-card-header>
          <mat-card-title>Spending Insights</mat-card-title>
          <mat-card-subtitle>Top categories this month</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          <div class="insights-list">
            @for (category of
            financeStore.currentMonthCategoryBreakdown().slice(0, 8); track
            category.category) {
            <div class="insight-item">
              <div class="insight-label">{{ category.category }}</div>
              <div class="insight-value">
                {{ formatCurrency(category.amount) }}
              </div>
              <div class="insight-bar">
                <mat-progress-bar
                  mode="determinate"
                  [value]="
                    (category.amount / financeStore.currentMonthExpenses()) *
                    100
                  "
                >
                </mat-progress-bar>
              </div>
            </div>
            }
          </div>
        </mat-card-content>
      </mat-card>
    </section>

    <!-- Analytics Grid -->
    <section class="analytics-section">
      <div class="analytics-grid">
        <mat-card class="analytics-card">
          <mat-card-header>
            <mat-card-title>Top Merchants</mat-card-title>
            <mat-card-subtitle>Where you spend most</mat-card-subtitle>
          </mat-card-header>
          <mat-card-content>
            <div class="merchants-list">
              @for (merchant of financeStore.topMerchants().slice(0, 5); track
              merchant.description) {
              <div class="merchant-item">
                <div class="merchant-info">
                  <div class="merchant-name">{{ merchant.description }}</div>
                  <div class="merchant-count">
                    {{ merchant.count }} transactions
                  </div>
                </div>
                <div class="merchant-amount">
                  {{ formatCurrency(merchant.amount) }}
                </div>
              </div>
              }
            </div>
          </mat-card-content>
        </mat-card>

        <mat-card class="analytics-card">
          <mat-card-header>
            <mat-card-title>Payment Methods</mat-card-title>
            <mat-card-subtitle>Usage breakdown</mat-card-subtitle>
          </mat-card-header>
          <mat-card-content>
            <div class="payment-methods-list">
              @for (medium of financeStore.mediumBreakdown().slice(0, 5); track
              medium.medium) {
              <div class="payment-method-item">
                <div class="payment-method-info">
                  <div class="payment-method-name">{{ medium.medium }}</div>
                  <div class="payment-method-stats">
                    {{ medium.count }} transactions
                  </div>
                </div>
                <div class="payment-method-chart">
                  <div
                    class="mini-bar income"
                    [style.width.%]="
                      (medium.income / (medium.income + medium.expenses)) * 100
                    "
                  ></div>
                  <div
                    class="mini-bar expense"
                    [style.width.%]="
                      (medium.expenses / (medium.income + medium.expenses)) *
                      100
                    "
                  ></div>
                </div>
              </div>
              }
            </div>
          </mat-card-content>
        </mat-card>

        <mat-card class="analytics-card">
          <mat-card-header>
            <mat-card-title>Quick Stats</mat-card-title>
            <mat-card-subtitle>At a glance</mat-card-subtitle>
          </mat-card-header>
          <mat-card-content>
            <div class="velocity-stats">
              <div class="velocity-stat">
                <div class="velocity-label">Avg/Month</div>
                <div class="velocity-value">
                  {{ getAverageMonthlySpending() | currency }}
                </div>
              </div>
              <div class="velocity-stat">
                <div class="velocity-label">Avg Transaction</div>
                <div class="velocity-value">
                  {{ getAverageTransactionAmount() | currency }}
                </div>
              </div>
              <div class="velocity-stat">
                <div class="velocity-label">Most Active</div>
                <div class="velocity-value">{{ getMostActiveDay() }}</div>
              </div>
            </div>
          </mat-card-content>
        </mat-card>
      </div>
    </section>

    <!-- Recent Transactions -->
    <section class="transactions-section">
      <mat-card class="recent-transactions-card">
        <mat-card-header>
          <mat-card-title>Recent Activity</mat-card-title>
          <mat-card-subtitle>Latest transactions</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          @if (recentTransactions().length === 0) {
          <div class="empty-state">
            <mat-icon fontIcon="fa-receipt"></mat-icon>
            <p>
              No transactions yet.
              <a (click)="navigateToTransactions()"
                >Add your first transaction</a
              >
            </p>
          </div>
          } @else {
          <div class="transactions-list">
            @for (transaction of recentTransactions().slice(0, 6); track
            transaction.id) {
            <div class="transaction-item">
              <div class="transaction-info">
                <div class="transaction-description">
                  {{ transaction.description }}
                </div>
                <div class="transaction-meta">
                  <mat-chip-set>
                    <mat-chip>{{ transaction.category }}</mat-chip>
                    <mat-chip>{{ transaction.medium }}</mat-chip>
                  </mat-chip-set>
                  <span class="transaction-date">{{
                    formatDate(transaction.date)
                  }}</span>
                </div>
              </div>
              <div
                class="transaction-amount"
                [class]="transaction.type.toLowerCase()"
              >
                {{ transaction.type === 'INCOME' ? '+' : '-'
                }}{{ formatCurrency(transaction.amount) }}
              </div>
            </div>
            }
          </div>
          <div class="view-all-container">
            <button
              mat-button
              color="primary"
              (click)="navigateToTransactions()"
            >
              View All Transactions
              <mat-icon fontIcon="fa-arrow-right"></mat-icon>
            </button>
          </div>
          }
        </mat-card-content>
      </mat-card>
    </section>
  </div>

  }
</div>
