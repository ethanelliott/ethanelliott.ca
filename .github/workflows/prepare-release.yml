name: Prepare Release

on:
  workflow_dispatch:
    inputs:
      release_type:
        description: 'Release Type'
        required: true
        type: choice
        options:
          - auto
          - patch
          - minor
          - major
          - prerelease
        default: 'auto'
      preid:
        description: 'Pre-release identifier (e.g., rc, alpha, beta) - only used with prerelease type'
        required: false
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  prepare-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '24.8.0'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Configure Git
        run: |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"

      - name: Run prepare-release script
        id: prepare
        run: |
          if [ "${{ github.event.inputs.release_type }}" = "prerelease" ]; then
            npm run release:prepare -- --type=prerelease --preid=${{ github.event.inputs.preid }}
          else
            npm run release:prepare -- --type=${{ github.event.inputs.release_type }}
          fi
        env:
          RELEASE_TYPE: ${{ github.event.inputs.release_type }}
          PREID: ${{ github.event.inputs.preid }}

      - name: Update deployment manifests
        run: |
          echo "Updating Helm values.yaml files with new versions..."
          npm run update:deployments

      - name: Get version information
        id: version
        run: |
          # Extract version from one of the changed package.json files
          VERSION=$(git diff HEAD -- 'apps/*/package.json' | grep '+"version"' | head -n 1 | sed 's/.*"\([0-9.a-z-]*\)".*/\1/')
          if [ -z "$VERSION" ]; then
            echo "No version changes detected"
            echo "version=no-changes" >> $GITHUB_OUTPUT
          else
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "Detected version: $VERSION"
          fi

      - name: Create Pull Request
        if: steps.version.outputs.version != 'no-changes'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'chore(release): publish ${{ steps.version.outputs.version }}'
          branch: release/v${{ steps.version.outputs.version }}
          delete-branch: true
          title: 'chore(release): publish ${{ steps.version.outputs.version }}'
          body: |
            ## Release v${{ steps.version.outputs.version }}

            This PR was automatically generated by the Prepare Release workflow.

            ### Release Type
            - **Type**: ${{ github.event.inputs.release_type }}
            ${{ github.event.inputs.release_type == 'prerelease' && format('- **Pre-release ID**: {0}', github.event.inputs.preid) || '' }}

            ### Changes
            This PR includes:
            - Version bumps in package.json files
            - Updated CHANGELOG.md files
            - Updated Helm values.yaml files with new Docker image tags

            ### Deployments
            When this PR is merged, ArgoCD will automatically detect the updated image tags and roll out the new versions to the cluster.

            ### What happens next?
            1. Review the changes in this PR
            2. Merge this PR to trigger the release workflow
            3. The release workflow will:
               - Create git tags for the new versions
               - Build and push Docker images with version tags
               - Create GitHub releases

            ---

            **⚠️ Note**: This PR should be merged using "Merge commit" (not squash) to preserve the commit message format `chore(release): publish`.
          labels: |
            release
            automated

      - name: No changes detected
        if: steps.version.outputs.version == 'no-changes'
        run: |
          echo "::warning::No version changes were detected. This might mean:"
          echo "  - No conventional commits since last release"
          echo "  - All projects are already at the target version"
          exit 1
